/*
 * Created on 4 janv. 2005
 * by binou
 * Copyright: GPL - UMLV(FR) - 2004/2005
 */

package fr.umlv.ir3.flexitime.richClient.gui.panel.exploitation;

import java.awt.*;
import java.awt.datatransfer.Transferable;
import java.awt.datatransfer.UnsupportedFlavorException;
import java.awt.dnd.DnDConstants;
import java.awt.dnd.DragGestureEvent;
import java.awt.dnd.DragGestureListener;
import java.awt.dnd.DragSource;

import java.awt.dnd.DragSourceDragEvent;
import java.awt.dnd.DragSourceDropEvent;
import java.awt.dnd.DragSourceEvent;
import java.awt.dnd.DragSourceListener;
import java.awt.dnd.DropTarget;
import java.awt.dnd.DropTargetDragEvent;
import java.awt.dnd.DropTargetDropEvent;
import java.awt.dnd.DropTargetEvent;
import java.awt.dnd.DropTargetListener;
import java.awt.image.BufferedImage;
import java.io.IOException;
import java.util.ArrayList;
import java.util.List;

import javax.swing.*;

import fr.umlv.ir3.flexitime.common.data.activity.IBusy;
import fr.umlv.ir3.flexitime.common.data.activity.ILesson;
import fr.umlv.ir3.flexitime.common.data.resources.IResource;
import fr.umlv.ir3.flexitime.common.gui.models.BusyBloc;
import fr.umlv.ir3.flexitime.common.gui.models.RessourcePlanningModel;
import fr.umlv.ir3.flexitime.common.gui.event.PlanningDataEvent;
import fr.umlv.ir3.flexitime.common.gui.event.PlanningDataListener;
import fr.umlv.ir3.flexitime.richClient.gui.panel.exploitation.menu.TransferableCourse;
import fr.umlv.ir3.flexitime.richClient.gui.panel.exploitation.menu.TransferableRessource;
import fr.umlv.ir3.flexitime.richClient.gui.renderers.PlanningTrimCellHeaderRenderer;
import fr.umlv.ir3.flexitime.richClient.gui.renderers.PlanningTrimCellRenderer;

/**
 * A component that allows the user to manage a planning A separate model,
 * <code>EDTModel</code>, represents the contents of the planning.
 * 
 * @version 0.1
 * @see RessourcePlanningModel
 * @see PlanningTrimCellRenderer
 * @see PlanningTrimCellHeaderRenderer
 * @author FlexiTeam - binou
 */
public class JRessourcePlanning extends JPanel implements PlanningDataListener
{

    /**
     * Comment for <code>serialVersionUID</code>
     */
    private static final long              serialVersionUID = 3257283613144986167L;

    /**
     * Comment for <code>WEEK_WIDTH</code>
     */
    public static final int                WEEK_WIDTH       = 90;
    /**
     * Comment for <code>DAY_HEIGTH</code>
     */
    public static final int                DAY_HEIGTH       = 18;
    /**
     * Comment for <code>DAY_COLUMN_WIDTH</code>
     */
    public static final int                DAY_COLUMN_WIDTH = 75;

    /**
     * Comment for <code>GAP_HEIGTH</code>
     */
    public static int                      GAP_HEIGTH;

    // TODO changer les tailles pour les calculer suivant les parametres du
    // modele

    private GridBagLayout                  gbl;

    private DragSource                     dragSource;
    private DropTarget                     dropTarget;
    private static BufferedImage           buffImage        = null;                // buff
                                                                                    // image
    private static Point                   cursorPoint      = new Point();

    private List<JBusy>                    selectedItems;

    private RessourcePlanningModel         model;
    private PlanningTrimCellRenderer       cellRenderer;
    private PlanningTrimCellHeaderRenderer cellHeaderRenderer;

    /**
     * Creates a new FlexiPlanning, using the specified model
     * 
     * @param model the model to reprensents the data
     */
    public JRessourcePlanning(RessourcePlanningModel model)
    {
        super();

        // this.gbl = new GridBagLayout();
        // setLayout(gbl);

        dragSource = new DragSource();
        ComponentDragSourceListener tdsl = new ComponentDragSourceListener();
        dragSource.createDefaultDragGestureRecognizer(this,
                DnDConstants.ACTION_COPY_OR_MOVE,
                new ComponentDragGestureListener(tdsl));
        ComponentDropTargetListener tdtl = new ComponentDropTargetListener();
        dropTarget = new DropTarget(this, DnDConstants.ACTION_MOVE, tdtl);
        dropTarget.getClass();

        this.model = model;
        this.cellRenderer = new PlanningTrimCellRenderer();
        this.cellHeaderRenderer = new PlanningTrimCellHeaderRenderer();

        this.model.addPlanningDataListener(this);

        this.selectedItems = new ArrayList<JBusy>();

        this.init();

    }

    /**
     * Returns the model of the FlexiEDT
     * 
     * @return the model used by the component
     * @see RessourcePlanningModel
     * @author FlexiTeam - binou
     */
    public RessourcePlanningModel getModel()
    {
        return model;
    }

    /**
     * Change the range of week currently used for the planning <br>
     * the result will be the previous Gap of week
     */
    public void fullStepBack()
    {
        model.fullStepBack();
        this.init();
    }

    /**
     * Change the range of week currently used for the planning <br>
     * the result will be the same gap but one week earlier
     */
    public void stepBack()
    {
        model.stepBack();
        this.init();
    }

    /**
     * Change the range of week currently used for the planning <br>
     * the result will be the the same gap without the ending week
     */
    public void decrease()
    {
        model.decrease();
        this.init();
    }

    /**
     * Change the range of week currently used for the planning <br>
     * the result will be the the same gap with another week added
     */
    public void increase()
    {
        model.increase();
        this.init();
    }

    /**
     * Change the range of week currently used for the planning <br>
     * the result will be the same gap but one week later
     */
    public void stepOver()
    {
        model.stepOver();
        this.init();
    }

    /**
     * Change the range of week currently used for the planning <br>
     * the result will be the next Gap of week
     */
    public void fullStepOver()
    {
        model.fullStepOver();
        this.init();
    }

    /**
     * Decrease the size of gap's time
     */
    public void lessGapTime()
    {
        model.lessGapTime();
        this.init();
    }

    /**
     * Increase the size of gap's time
     */
    public void moreGapTime()
    {
        model.moreGapTime();
        this.init();
    }

    /**
     * Sets the current Component selected in the planning
     * 
     * @param currentSelected
     * @param ctrl
     */
    public void setCurrentSelected(JBusy currentSelected, boolean ctrl)
    {
        if (ctrl)
        {
            if (!selectedItems.remove(currentSelected))
            {
                selectedItems.add(currentSelected);
                currentSelected.setSelected(true);
            }
            else
                currentSelected.setSelected(false);
        }
        else
        {
            for (JBusy busy : selectedItems)
            {
                busy.setSelected(false);
            }
            selectedItems.clear();
            selectedItems.add(currentSelected);
            currentSelected.setSelected(true);
        }

    }

    /**
     * Initialyse the time table Is only used at the creation
     * 
     * @author FlexiTeam - binou
     */
    private void init()
    {
        this.gbl = new GridBagLayout();
        GAP_HEIGTH = model.getGapUnit() / 5 * model.getGapMultiplicateur();
        setLayout(this.gbl);
        revalidate();
        removeAll();
        this.createWeekLign();
        this.createDayColumn();
        this.fillLesson();
        repaint();
    }

    /**
     * Generate the week Header of the time table containing the number of each
     * week
     * 
     * @author FlexiTeam - binou
     */
    private void createWeekLign()
    {
        for (int i = 0 ; i < model.getNbWeeks() ; i++)
            addWeekHeader(i + 1, 0, i); // +1 =+dayColumn
    }

    /**
     * Generate the first Column of the planning containing :<br>- the name of
     * each day - all gap's header - each date of each days on each weeks Is
     * only used at the creation
     * 
     * @author FlexiTeam - binou
     */
    private void createDayColumn()
    {
        int tempY;
        for (int i = 0 ; i < model.getNbDays() ; i++)
        {
            tempY = i * ( model.getDayGapSize() + 1 ) + 1; // dernier +1 =
                                                            // +weekLign
            addDayHeader(0, tempY, i);
            for (int j = 0 ; j < model.getNbWeeks() ; j++)
                addDateHeader(j + 1, tempY, j, i);
            int length;
            int cur = tempY + 1;
            for (int j = 0 ; j < model.getNbBloc() ; j++)
            {
                length = model.getBlocSize(j);
                addGapHeader(0, cur, j, length);
                cur += length;
            }
        }
    }

    /**
     * Generate the data in the planning : - each Lessons - each empty space (no
     * lessons) Is only used at the creation
     * 
     * @author FlexiTeam - binou
     */
    private void fillLesson()
    {
        int tempY;
        for (int k = 0 ; k < model.getNbWeeks() ; k++)
        {
            for (int i = 0 ; i < model.getNbDays() ; i++)
            {
                tempY = i * ( model.getDayGapSize() + 1 ) + 1;
                for (int j = 0 ; j < model.getDayGapSize() ; j++)
                    // addEmptyLesson(k, tempY + j);
                    addGap(k + 1, ( tempY + 1 ) + j, k, i, j);
            }
        }
    }

    /**
     * Add to the layout a week header at the specified coordinate Is only used
     * at the creation
     * 
     * @param x the x coordinate
     * @param y the y coordinate
     * @param weekNumber the column number of the header to add
     * @author FlexiTeam - binou
     */
    private void addWeekHeader(int x, int y, int weekNumber)
    {
        JComponent comp = cellHeaderRenderer.getEDTCellHeaderRendererComponent(
                this, model.getWeekHeaderAt(weekNumber),
                PlanningTrimCellHeaderRenderer.WEEK_HEADER);

        GridBagConstraints c = new GridBagConstraints();
        c.gridx = x;
        c.gridy = y;
        add(comp, c);
    }

    /**
     * Add to the layout a date header at the specified coordinate Is only used
     * at the creation
     * 
     * @param x the x coordinate
     * @param y the y coordinate
     * @param weekNumber the week number of the date to add
     * @param dayNumber the day number of the header to add
     * @author FlexiTeam - binou
     */
    private void addDateHeader(int x, int y, int weekNumber, int dayNumber)
    {
        JComponent comp = cellHeaderRenderer.getEDTCellHeaderRendererComponent(
                this, model.getDateHeaderAt(weekNumber, dayNumber),
                PlanningTrimCellHeaderRenderer.DATE_HEADER);

        GridBagConstraints c = new GridBagConstraints();
        c.gridx = x;
        c.gridy = y;
        add(comp, c);
    }

    /**
     * Add to the layout a gap header at the specified coordinate Is only used
     * at the creation
     * 
     * @param x the x coordinate
     * @param y the y coordinate
     * @param length
     * @param gapNumber the gap number of the header to add
     * @author FlexiTeam - binou
     */
    private void addGapHeader(int x, int y, int blocNumber, int length)
    {
        JComponent comp = cellHeaderRenderer.getEDTCellHeaderRendererComponent(
                this, model.getGapHeaderAt(blocNumber),
                PlanningTrimCellHeaderRenderer.GAP_HEADER);

        GridBagConstraints c = new GridBagConstraints();
        c.gridx = x;
        c.gridy = y;
        c.gridheight = length;
        c.fill = GridBagConstraints.VERTICAL;
        add(comp, c);
    }

    /**
     * Add to the layout a day header at the specified coordinate Is only used
     * at the creation
     * 
     * @param x the x coordinate
     * @param y the y coordinate
     * @param dayNumber - the day number of the header to add
     * @author FlexiTeam - binou
     */
    private void addDayHeader(int x, int y, int dayNumber)
    {
        JComponent comp = cellHeaderRenderer.getEDTCellHeaderRendererComponent(
                this, model.getDayHeaderAt(dayNumber),
                PlanningTrimCellHeaderRenderer.DAY_HEADER);

        GridBagConstraints c = new GridBagConstraints();
        c.gridx = x;
        c.gridy = y;
        add(comp, c);
    }

    /**
     * Quel service est rendu par cette méthode
     * <code>exemple d'appel de la methode</code>
     * 
     * @param weekNumber
     * @param dayNumber
     * @param gapNumber
     * @author FlexiTeam - binou
     */
    private void addGap(int x, int y, int weekNumber, int dayNumber,
            int gapNumber)
    {

        JComponent comp = cellRenderer.getEDTCellRendererComponent(this, model
                .getElementAt(weekNumber, dayNumber, gapNumber), weekNumber,
                dayNumber, gapNumber);
        if (comp != null)
        {
            GridBagConstraints c = new GridBagConstraints();
            c.gridx = x;
            c.gridy = y;
            if (comp instanceof JBusy)
            {
                c.gridheight = ( (JBusy) comp ).getNbGaps();
                // System.out.println("placement sur " +
                // ((JBusy)comp).getNbGaps());
                c.fill = GridBagConstraints.VERTICAL;
            }
            add(comp, c);
        }
    }

    private void addGap(int weekNumber, int daynumber, int lowerGap)
    {
        addGap(weekNumber + 1, 1 + daynumber * ( model.getDayGapSize() + 1 )
                + lowerGap + 1, weekNumber, daynumber, lowerGap);
    }

    /**
     * convert an indice of column into the week number
     * 
     * @param columnNumber the column number
     * @return the week number
     * @author FlexiTeam - binou
     */
    private int xToWeek(int columnNumber)
    {
        return columnNumber - 1;
    }

    /**
     * convert an indice of lign into the day number
     * 
     * @param lignNumber the lign number
     * @return the day number
     * @author FlexiTeam - binou
     */
    private int yToDay(int lignNumber)
    {
        return ( lignNumber - 2 ) / ( model.getDayGapSize() + 1 );
    }

    /**
     * convert an indice of lign into the gap number in its day
     * 
     * @param lignNumber the lign number
     * @return the gap number in its day
     * @author FlexiTeam - binou
     */
    private int yToGapInTheDay(int lignNumber)
    {
        return lignNumber
                - ( yToDay(lignNumber) * ( model.getDayGapSize() + 1 ) + 1 )
                - 1;
    }

    /**
     * return true if the specified datagrid cordinate is a lesson gap
     * 
     * @param p the datagrid point
     * @return true if its a lesson gap
     * @author FlexiTeam - binou
     */
    private boolean isALessonGap(Point p)
    {
        if (p.x > model.getNbWeeks()) return false;
        return ! ( p.x <= 0 || p.y <= 1 || ( p.y - 1 )
                % ( model.getDayGapSize() + 1 ) == 0 );
    }

    /**
     * convert a week number into a pixel number +2 bug ... not a good way,
     * depend of the size
     * 
     * @author FlexiTeam - binou
     */
    private int weekToX(int week)
    {
        return DAY_COLUMN_WIDTH + week * WEEK_WIDTH + 2
                + gbl.getLayoutOrigin().x;
    }

    private int gapToY(int day, int gap)
    {
        return DAY_HEIGTH
                + ( model.getDayGapSize() * day * GAP_HEIGTH + DAY_HEIGTH
                        * ( day + 1 ) ) + GAP_HEIGTH * gap + 2
                + +gbl.getLayoutOrigin().y;
    }

    private Component getComponentAt(int week, int day, int gap)
    {
        return getComponentAt(weekToX(week), gapToY(day, gap));
    }

    /**
     * Change the style of a gap in (x,y) and the followings, when there's a
     * drag over them
     * 
     * @param j
     * @param i
     * @see (si nécessaire)
     * @author FlexiTeam - binou
     */
    private void setDragOverStyle(int x, int y, boolean value)
    {
        Component comp = getComponentAt(xToWeek(x), yToDay(y),
                yToGapInTheDay(y));
        if (comp instanceof JBusy)
        {
            JBusy jlesson = (JBusy) comp;
            jlesson.setDragOver(value);
            // Rectangle rect2Dselect = new Rectangle(jlesson.getBounds());
            // paintImmediately(rect2Dselect.getBounds());
        }
    }

    /**
     * Sent after the indices in the lowerGap,upperGap interval have been
     * inserted in the data model. The new interval includes both lowerGap and
     * upperGap.
     * 
     * @param e a <code>PlanningDataEvent</code> encapsulating the event
     *        information
     */
    public void intervalAdded(PlanningDataEvent e)
    {
        System.out.println("intervalAdded() de " + e.getLowerGap()); //$NON-NLS-1$
        System.out.println(e.getUpperGap());
        for (int i = e.getLowerGap() ; i <= e.getUpperGap() ; i++)
            remove(getComponentAt(e.getWeekNumber(), e.getDaynumber(), i));

        for (int i = e.getLowerGap() ; i <= e.getUpperGap() ; i++)
            addGap(e.getWeekNumber(), e.getDaynumber(), i);

        // System.out.println(model.getDayGapSize() + "*" +e.getDaynumber()+ "*"
        // + GAP_HEIGTH + "+" +DAY_HEIGTH+ "*" +(e.getDaynumber()+1)+"+"+
        // GAP_HEIGTH + "*" + e.getLowerGap() + "+ 2" );
        // System.out.println(x + " - " + y);
    }

    /**
     * Sent after the indices in the lowerGap,upperGap interval have been
     * removed from the data model. The interval includes both lowerGap and
     * upperGap.
     * 
     * @param e a <code>PlanningDataEvent</code> encapsulating the event
     *        information
     */
    public void intervalRemoved(PlanningDataEvent e)
    {
        e.getClass();
    }

    /**
     * Sent when the contents of the list has changed in a way that's too
     * complex to characterize with the previous methods. For example, this is
     * sent when an item has been replaced. lowerGap and upperGap bracket the
     * change.
     * 
     * @param e a <code>PlanningDataEvent</code> encapsulating the event
     *        information
     */
    public void contentsChanged(PlanningDataEvent e)
    {
        e.getClass();
    }

    final class ComponentDragSourceListener implements DragSourceListener
    {

        /**
         * @see java.awt.dnd.DragSourceListener#dragDropEnd(java.awt.dnd.DragSourceDropEvent)
         * @author FlexiTeam - binou
         */
        public void dragDropEnd(DragSourceDropEvent dsde)
        {
            dsde.getClass();
        }

        /**
         * @see java.awt.dnd.DragSourceListener#dragEnter(java.awt.dnd.DragSourceDragEvent)
         * @author FlexiTeam - binou
         */
        public void dragEnter(DragSourceDragEvent dsde)
        {
            int action = dsde.getDropAction();
            if (action == DnDConstants.ACTION_MOVE)
            {
                dsde.getDragSourceContext().setCursor(
                        DragSource.DefaultMoveDrop);
            }
            else
            {
                dsde.getDragSourceContext().setCursor(
                        DragSource.DefaultMoveNoDrop);
            }
        }

        /**
         * @see java.awt.dnd.DragSourceListener#dragOver(java.awt.dnd.DragSourceDragEvent)
         * @author FlexiTeam - binou
         */
        public void dragOver(DragSourceDragEvent dsde)
        {
            int action = dsde.getDropAction();
            if (action == DnDConstants.ACTION_MOVE)
            {
                dsde.getDragSourceContext().setCursor(
                        DragSource.DefaultMoveDrop);
            }
            else
            {
                dsde.getDragSourceContext().setCursor(
                        DragSource.DefaultMoveNoDrop);
            }
        }

        /**
         * @see java.awt.dnd.DragSourceListener#dropActionChanged(java.awt.dnd.DragSourceDragEvent)
         * @author FlexiTeam - binou
         */
        public void dropActionChanged(DragSourceDragEvent dsde)
        {
            int action = dsde.getDropAction();
            if (action == DnDConstants.ACTION_MOVE)
            {
                dsde.getDragSourceContext().setCursor(
                        DragSource.DefaultMoveDrop);
            }
            else
            {
                dsde.getDragSourceContext().setCursor(
                        DragSource.DefaultMoveNoDrop);
            }
        }

        /**
         * @see java.awt.dnd.DragSourceListener#dragExit(java.awt.dnd.DragSourceEvent)
         * @author FlexiTeam - binou
         */
        public void dragExit(DragSourceEvent dse)
        {

            dse.getDragSourceContext().setCursor(DragSource.DefaultMoveNoDrop);
        }
    }

    final class ComponentDragGestureListener implements DragGestureListener
    {

        ComponentDragSourceListener tdsl;

        /**
         * @param tdsl
         */
        public ComponentDragGestureListener(ComponentDragSourceListener tdsl)
        {
            this.tdsl = tdsl;
        }

        /**
         * @see java.awt.dnd.DragGestureListener#dragGestureRecognized(java.awt.dnd.DragGestureEvent)
         * @author FlexiTeam - binou
         */
        public void dragGestureRecognized(DragGestureEvent dge)
        {

            Point p_abs = dge.getDragOrigin();
            Point p_rel = gbl.location(p_abs.x, p_abs.y);

            // lit le label sur la grille d'origine
            Component comp = getComponentAt(p_abs);

            // on test si c bien une case de cours et si c bien un cours ...
            // sinon pas de drag !
            if (comp != null
                    && comp instanceof JBusy
                    && comp != JRessourcePlanning.this
                    && isALessonGap(p_rel)
                    && model.isALesson(xToWeek(p_rel.x), yToDay(p_rel.y),
                            yToGapInTheDay(p_rel.y)))
            {
                // Generation de l'image
                cursorPoint.setLocation(SwingUtilities.convertPoint(
                        JRessourcePlanning.this, dge.getDragOrigin(), comp));
                buffImage = new BufferedImage(comp.getWidth(),
                        comp.getHeight(),
                        java.awt.image.BufferedImage.TYPE_INT_ARGB_PRE);// buffered
                                                                        // image
                                                                        // reference
                                                                        // passing
                                                                        // the
                                                                        // comp's
                                                                        // ht
                                                                        // and
                                                                        // width
                Graphics2D graphics = buffImage.createGraphics();// creating
                                                                    // the
                                                                    // graphics
                                                                    // for
                                                                    // buffered
                                                                    // image
                graphics.setComposite(AlphaComposite.getInstance(
                        AlphaComposite.SRC_OVER, 0.5f)); // Sets the
                                                            // Composite for the
                                                            // Graphics2D
                                                            // context
                boolean opacity = ( (JComponent) comp ).isOpaque();
                if (opacity)
                {
                    ( (JComponent) comp ).setOpaque(false);
                }
                comp.paint(graphics);
                if (opacity)
                {
                    ( (JComponent) comp ).setOpaque(true);
                }
                graphics.dispose();

                dragSource.startDrag(dge, DragSource.DefaultMoveDrop,
                        buffImage, cursorPoint, new TransferableLessonBloc(
                                new BusyBloc( ( (JBusy) comp ).getBusy())),
                        tdsl);
                revalidate();
                repaint();
            }
        }
    }

    final class ComponentDropTargetListener implements DropTargetListener
    {

        Insets            insets;
        private Rectangle rect2D    = new Rectangle();
        // garde en mémoire le drag point potentiel actuel ainsi ke la longueur
        // de l'ajout potentiel
        private Point     dragPoint = new Point();
        private int       length;

        /**
         * @see java.awt.dnd.DropTargetListener#dragEnter(java.awt.dnd.DropTargetDragEvent)
         * @author FlexiTeam - binou
         */
        public void dragEnter(DropTargetDragEvent dtde)
        {
            dtde.getClass();
            dragPoint.setLocation(-1, -1);
            
//            Point p_rel = dtde.getLocation();
//            
//            //on devrait désactiver le drop mais ca marche pas la :(
//            if(!isALessonGap(p_rel))
//            {
//                dtde.rejectDrag();
//                paintImmediately(rect2D.getBounds());
//                return;
//            }

            // System.out.println("dragEnter() at " +
            // System.currentTimeMillis());
            /*
             * Point pt = dtde.getLocation();
             * paintImmediately(rect2D.getBounds()); rect2D.setRect((int)
             * (pt.getX()-cursorPoint.getX()),(int)
             * (pt.getY()-cursorPoint.getY()),buffImage.getWidth(),buffImage.getHeight());
             * ((Graphics2D) getGraphics()).drawImage(buffImage,(int)
             * (pt.getX()-cursorPoint.getX()),(int)
             * (pt.getY()-cursorPoint.getY()),FlexiEDT.this);
             * dtde.acceptDrag(dtde.getDropAction());
             */

        }

        /**
         * @see java.awt.dnd.DropTargetListener#dragExit(java.awt.dnd.DropTargetEvent)
         * @author FlexiTeam - binou
         */
        public void dragExit(DropTargetEvent dte)
        {
            dte.getClass();

            // redessine la partie du buffImage pour qu'il disparaisse vu kon
            // sort d'une zone de drop
            paintImmediately(rect2D.getBounds());
            for (int i = dragPoint.y ; i < dragPoint.y + length ; i++)
                setDragOverStyle(dragPoint.x, i, false);
            dragPoint.setLocation(-1, -1);
        }

        /**
         * @see java.awt.dnd.DropTargetListener#dragOver(java.awt.dnd.DropTargetDragEvent)
         * @author FlexiTeam - binou
         */
        public void dragOver(DropTargetDragEvent dtde)
        {
            
            Point p_abs = dtde.getLocation();
            Point p_rel = gbl.location(p_abs.x, p_abs.y);

            //si on est pas dans le cas d'une case de cours ... on désactive le drag. On aplus rien a faire dans cette méthode
            if(!isALessonGap(p_rel))
            {
                dtde.rejectDrag();
                paintImmediately(rect2D.getBounds());
                return;
            }
            
            //on lit le transferable en cours de drag et on va tester son flavor
            Transferable transferable = dtde.getTransferable();
            
            //Cas d'un copier coller d'un autre cours
            if(transferable.isDataFlavorSupported(TransferableLessonBloc.BUSYBLOC_FLAVOR))
            {
                //System.out.println("dragOver() d'une BusyBloc at " + System.currentTimeMillis()); //$NON-NLS-1$
                // on desactive le drop si on est pas sur une case de cours ou
                // si on est sur un cours
                if (model.isALesson(xToWeek(p_rel.x), yToDay(p_rel.y),
                                yToGapInTheDay(p_rel.y)))
                {
                    dtde.rejectDrag();
                    paintImmediately(rect2D.getBounds());
                }
                else
                {
                    paintImmediately(rect2D.getBounds());
                    rect2D.setRect((int) ( p_abs.getX() - cursorPoint.getX() ),
                            (int) ( p_abs.getY() - cursorPoint.getY() ),
                            buffImage.getWidth(), buffImage.getHeight());

                    ( (Graphics2D) getGraphics() ).drawImage(buffImage,
                            (int) ( p_abs.getX() - cursorPoint.getX() ),
                            (int) ( p_abs.getY() - cursorPoint.getY() ),
                            JRessourcePlanning.this);
                    dtde.acceptDrag(dtde.getDropAction());

                    try
                    {
                        // on test kon a bien changer de sélection
                        if (dragPoint.x != p_rel.x || dragPoint.y != p_rel.y)
                        {
                            // Lecture du lesson bloc à dragguer
                            BusyBloc busy = (BusyBloc) transferable
                                    .getTransferData(TransferableLessonBloc.BUSYBLOC_FLAVOR);

                            // On déselectionne le dragOverStyle précédent
                            if (dragPoint.x != -1 && dragPoint.y != -1)
                            {
                                for (int i = dragPoint.y ; i < dragPoint.y
                                        + length ; i++)
                                    setDragOverStyle(dragPoint.x, i, false);
                            }

                            // on mémorise pour la suite le nous point de drag
                            // potentiel et sa longueur
                            dragPoint.setLocation(p_rel.x, p_rel.y);

                            // on regarde combien de créneau nous est disponible
                            int nbEmptyGap = model.getNbEmptyGapAt(
                                    xToWeek(p_rel.x), yToDay(p_rel.y),
                                    yToGapInTheDay(p_rel.y));
                            if (nbEmptyGap <= 0)
                                System.out.println("Oula gros pb :s"); //$NON-NLS-1$

                            if (busy.getNbGap() > nbEmptyGap)
                                length = nbEmptyGap;
                            else
                                length = busy.getNbGap();

                            // on sélectionne la zone du drag potentiel
                            for (int i = p_rel.y ; i < p_rel.y + length ; i++)
                                setDragOverStyle(p_rel.x, i, true);

                        }
                    }
                    catch (UnsupportedFlavorException e)
                    {
                        e.printStackTrace();
                    }
                    catch (IOException e)
                    {
                        e.printStackTrace();
                    }
                }
            }//Cas d'un drag d'un Cours
            else if (transferable.isDataFlavorSupported(TransferableCourse.ICOURSE_FLAVOR))
            {
                //System.out.println("dragOver() d'une Course at " + System.currentTimeMillis()); //$NON-NLS-1$
                ;
            }//Cas d'un drag d'une ressoruce
            else if (transferable.isDataFlavorSupported(TransferableRessource.IRESSOURCE_FLAVOR))
            {
                if (!model.isALesson(xToWeek(p_rel.x), yToDay(p_rel.y),yToGapInTheDay(p_rel.y)))
                {
                    dtde.rejectDrag();
                }
                else
                {
                    //System.out.println("dragOver() d'une Ressource at " + System.currentTimeMillis()); //$NON-NLS-1$
                    dtde.acceptDrag(dtde.getDropAction());
                }

            }
        }

        /**
         * @see java.awt.dnd.DropTargetListener#dropActionChanged(java.awt.dnd.DropTargetDragEvent)
         * @author FlexiTeam - binou
         */
        public void dropActionChanged(DropTargetDragEvent dtde)
        {
            dtde.getClass();
            /*
             * Point pt = dtde.getLocation();
             * paintImmediately(rect2D.getBounds()); rect2D.setRect((int)
             * (pt.getX()-cursorPoint.getX()),(int)
             * (pt.getY()-cursorPoint.getY()),buffImage.getWidth(),buffImage.getHeight());
             * ((Graphics2D) getGraphics()).drawImage(buffImage,(int)
             * (pt.getX()-cursorPoint.getX()),(int)
             * (pt.getY()-cursorPoint.getY()),FlexiEDT.this);
             * dtde.acceptDrag(dtde.getDropAction());
             */
        }

        /** 
         * @see java.awt.dnd.DropTargetListener#drop(java.awt.dnd.DropTargetDropEvent)
         * @author   FlexiTeam - binou
         */
        public void drop(DropTargetDropEvent dtde)
        {
            Point location = dtde.getLocation();
            Point target = gbl.location(location.x, location.y);
            try
            {
                //System.out.println("ATTENTION drop !!!!");
                paintImmediately(rect2D.getBounds());
                //int action = dtde.getDropAction();
                Transferable transferable = dtde.getTransferable();
                if (transferable.isDataFlavorSupported(TransferableLessonBloc.BUSYBLOC_FLAVOR))
                {
                    System.out.println("DataFlavor OK : BUSYBLOC_FLAVOR"); //$NON-NLS-1$
                    // On recupere le lesson a droper
                    BusyBloc busyBloc = (BusyBloc) transferable
                            .getTransferData(TransferableLessonBloc.BUSYBLOC_FLAVOR);
                    busyBloc.setNbGap(length);
                    
                    if (busyBloc == null)
                    {
                        System.err.println("rien a dropper !!!"); //$NON-NLS-1$
                        dtde.rejectDrop();
                        dtde.dropComplete(false);
                        revalidate();
                        repaint();
                        //return;						
                    }
                    else
                    {
                        
                        //System.out.println("Ajout en [" + target.x + "," + target.y + "]" + "week " + xToWeek(target.x) + " day " + yToDay(target.y) + "gap " + yToGapInTheDay(target.y));
                        getModel().addElement(xToWeek(target.x),
                                yToDay(target.y), yToGapInTheDay(target.y),
                                busyBloc);

                        dtde.dropComplete(true);
                        revalidate();
                        repaint();
                        //return;
                    }
                }
                else if (transferable.isDataFlavorSupported(TransferableCourse.ICOURSE_FLAVOR))
                {
                    System.out.println("DataFlavor OK : ICOURSE_FLAVOR"); //$NON-NLS-1$
                }//Cas d'un drag d'une ressoruce
                else if (transferable.isDataFlavorSupported(TransferableRessource.IRESSOURCE_FLAVOR))
                {
                    System.out.println("DataFlavor OK : IRESSOURCE_FLAVOR"); //$NON-NLS-1$
                    IResource ressource = (IResource) transferable.getTransferData(TransferableRessource.IRESSOURCE_FLAVOR);
                    Component comp = getComponentAt(location.x, location.y);
                    GridBagConstraints c = gbl.getConstraints(comp);
                    if(comp instanceof JBusy)
                    {
                        IBusy busy = ((JBusy)comp).getBusy().getBusy();
                        if(busy instanceof ILesson)
                        {
                            ((ILesson)busy).addResource(ressource);
                            model.updateLesson(xToWeek(c.gridx), yToDay(c.gridy), yToGapInTheDay(c.gridy));
                        }
                        
                    }
                    

                }
                else
                {
                    System.out.println("Houston on a un probleme ! Mauvais flavor ... "); //$NON-NLS-1$

                    
                }
            }
            catch (Exception e)
            {
                System.out.println(e);
                dtde.rejectDrop();
                dtde.dropComplete(false);
            }
        }
    }

}
